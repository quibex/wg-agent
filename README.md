# WireGuard Agent

gRPC ÑÐµÑ€Ð²Ð¸Ñ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»Ñ‘Ð½Ð½Ð¾Ð³Ð¾ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ WireGuard Ñ‡ÐµÑ€ÐµÐ· Ð±Ð¾Ñ‚Ð°.

---

## Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚

### Ð¡Ñ…ÐµÐ¼Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹

```
[Ð¢Ð²Ð¾Ð¹ ÐºÐ¾Ð¼Ð¿] -- Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑˆÑŒ CA Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¸Ð¹ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ (1 Ñ€Ð°Ð·)
     â”‚
     â”œâ”€â”€ CA ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º [VPS ÑÐµÑ€Ð²ÐµÑ€ 1] -- setup-server.sh
     â”œâ”€â”€ CA ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º [VPS ÑÐµÑ€Ð²ÐµÑ€ 2] -- setup-server.sh
     â”œâ”€â”€ CA ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º [VPS ÑÐµÑ€Ð²ÐµÑ€ N] -- setup-server.sh
     â”‚
     â””â”€â”€ ÐšÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¸Ð¹ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ â”€â”€â–º [kurut-bot] -- Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ÑÑ ÐºÐ¾ Ð²ÑÐµÐ¼ ÑÐµÑ€Ð²ÐµÑ€Ð°Ð¼
```

**ÐžÐ´Ð¸Ð½ CA = Ð¾Ð´Ð¸Ð½ ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¸Ð¹ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ = Ð²ÑÐµ ÑÐµÑ€Ð²ÐµÑ€Ð°.**

---

## Ð¨Ð°Ð³ 1. Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ CA (Ð´ÐµÐ»Ð°ÐµÑ‚ÑÑ ÐžÐ”Ð˜Ð Ñ€Ð°Ð· Ð½Ð° Ñ‚Ð²Ð¾Ñ‘Ð¼ ÐºÐ¾Ð¼Ð¿Ðµ)

```bash
cd wg-agent
./scripts/make-ca-only.sh
```

Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ ÑÐ¾Ð·Ð´Ð°ÑÑ‚:
- `certs/ca.pem` â€” Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ CA
- `certs/ca-key.pem` â€” Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ CA (Ñ…Ñ€Ð°Ð½Ð¸ Ð² Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸!)

Ð˜ Ð²Ñ‹Ð²ÐµÐ´ÐµÑ‚ 3 ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð´Ð»Ñ `.env`:
```
CA_CERT_PEM=LS0tLS1CRUdJTi...Ð´Ð»Ð¸Ð½Ð½Ð°Ñ_base64_ÑÑ‚Ñ€Ð¾ÐºÐ°...
CA_KEY_PEM=LS0tLS1CRUdJTi...Ð´Ð»Ð¸Ð½Ð½Ð°Ñ_base64_ÑÑ‚Ñ€Ð¾ÐºÐ°...
SERVER_PUBLIC_IP=your.server.ip.address
```

**Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸ ÑÑ‚Ð¸ ÑÑ‚Ñ€Ð¾ÐºÐ¸** â€” Ð¾Ð½Ð¸ Ð½ÑƒÐ¶Ð½Ñ‹ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð½Ð¾Ð²Ð¾Ð³Ð¾ ÑÐµÑ€Ð²ÐµÑ€Ð°.

> Ð•ÑÐ»Ð¸ Ð¿Ð¾Ñ‚ÐµÑ€ÑÐ» Ð²Ñ‹Ð²Ð¾Ð´, Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸ `./scripts/get-env.sh` Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¸Ñ… ÑÐ½Ð¾Ð²Ð°.

---

## Ð¨Ð°Ð³ 2. Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¾Ð³Ð¾ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð° Ð´Ð»Ñ Ð±Ð¾Ñ‚Ð° (Ð´ÐµÐ»Ð°ÐµÑ‚ÑÑ ÐžÐ”Ð˜Ð Ñ€Ð°Ð·)

```bash
./scripts/make-client-cert.sh
```

Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ ÑÐ¾Ð·Ð´Ð°ÑÑ‚:
- `certs/client.pem` â€” ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¸Ð¹ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚
- `certs/client-key.pem` â€” Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°

Ð˜ Ð²Ñ‹Ð²ÐµÐ´ÐµÑ‚ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð±Ð¾Ñ‚Ð°:
```
WIREGUARD_TLS_CA_CERT=...base64...
WIREGUARD_TLS_CLIENT_CERT=...base64...
WIREGUARD_TLS_CLIENT_KEY=...base64...
WIREGUARD_TLS_SERVER_NAME=wg-agent
```

**Ð”Ð¾Ð±Ð°Ð²ÑŒ ÑÑ‚Ð¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð² `.env` Ñ„Ð°Ð¹Ð» kurut-bot.**

---

## Ð¨Ð°Ð³ 3. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° wg-agent Ð½Ð° Ð½Ð¾Ð²Ñ‹Ð¹ VPS

### ÐÐ° ÑÐµÑ€Ð²ÐµÑ€Ðµ:

```bash
# 1. Ð¡ÐºÐ°Ñ‡Ð°Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
wget https://raw.githubusercontent.com/quibex/wg-agent/main/scripts/setup-server.sh
chmod +x setup-server.sh

# 2. Ð¡Ð¾Ð·Ð´Ð°Ð¹ .env Ñ„Ð°Ð¹Ð» (Ð²ÑÑ‚Ð°Ð²ÑŒ ÑÐ²Ð¾Ð¸ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð¸Ð· Ð¨Ð°Ð³Ð° 1)
cat > .env << 'EOF'
CA_CERT_PEM=Ñ‚Ð²Ð¾Ñ_base64_ÑÑ‚Ñ€Ð¾ÐºÐ°_Ð¸Ð·_ÑˆÐ°Ð³Ð°_1
CA_KEY_PEM=Ñ‚Ð²Ð¾Ñ_base64_ÑÑ‚Ñ€Ð¾ÐºÐ°_Ð¸Ð·_ÑˆÐ°Ð³Ð°_1
SERVER_PUBLIC_IP=123.45.67.89
EOF

# 3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ
sudo ./setup-server.sh
```

Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸:
- Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ Go, WireGuard, OpenSSL
- ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ WireGuard Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ (wg0)
- Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ ÑÐµÑ€Ð²ÐµÑ€Ð½Ñ‹Ð¹ TLS ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚
- Ð¡Ð¾Ð±ÐµÑ€Ñ‘Ñ‚ Ð¸ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ wg-agent ÐºÐ°Ðº systemd ÑÐµÑ€Ð²Ð¸Ñ

### ÐŸÐ¾ÑÐ»Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð²Ñ‹Ð²ÐµÐ´ÐµÑ‚:

```
ðŸ“¡ Connection Parameters for Bot (copy these):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Endpoint:           123.45.67.89:51820
GRPCAddress:        123.45.67.89:7443
```

**Ð­Ñ‚Ð¸ Ð´Ð²Ð° Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð° Ð½ÑƒÐ¶Ð½Ñ‹ Ð´Ð»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐµÑ€Ð²ÐµÑ€Ð° Ð² Ð±Ð¾Ñ‚Ð°.**

---

## Ð¨Ð°Ð³ 4. Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐµÑ€Ð²ÐµÑ€Ð° Ð² Ð±Ð¾Ñ‚Ð°

Ð’ Telegram Ð±Ð¾Ñ‚Ðµ:
1. ÐÐ°Ð¿Ð¸ÑˆÐ¸ `/add_wg_server`
2. Ð’Ð²ÐµÐ´Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ ÑÐµÑ€Ð²ÐµÑ€Ð° (Ð»ÑŽÐ±Ð¾Ðµ, Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ "Germany-1")
3. Ð’Ð²ÐµÐ´Ð¸ **Endpoint**: `123.45.67.89:51820`
4. Ð’Ð²ÐµÐ´Ð¸ **GRPCAddress**: `123.45.67.89:7443`

Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! Ð¡ÐµÑ€Ð²ÐµÑ€ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½.

---

## Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð²Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾/Ñ‚Ñ€ÐµÑ‚ÑŒÐµÐ³Ð¾/N ÑÐµÑ€Ð²ÐµÑ€Ð°

ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ **Ð¨Ð°Ð³ 3** Ð¸ **Ð¨Ð°Ð³ 4**.

CA Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¸Ð¹ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ â€” Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ‚Ðµ Ð¶Ðµ `CA_CERT_PEM` Ð¸ `CA_KEY_PEM`.

---

## ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ

```bash
# Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ°
systemctl status wg-agent

# Ð›Ð¾Ð³Ð¸
journalctl -u wg-agent -f

# ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº
systemctl restart wg-agent

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° WireGuard
wg show wg0

# Health check
curl http://localhost:8080/health
```

---

## ÐžÐ¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ .env (Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ)

| ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ | ÐŸÐ¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ | ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ |
|------------|--------------|----------|
| `WG_AGENT_INTERFACE` | `wg0` | Ð˜Ð¼Ñ WireGuard Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ° |
| `WG_AGENT_ADDR` | `0.0.0.0:7443` | ÐÐ´Ñ€ÐµÑ gRPC ÑÐµÑ€Ð²ÐµÑ€Ð° |
| `WG_AGENT_HTTP_ADDR` | `0.0.0.0:8080` | ÐÐ´Ñ€ÐµÑ HTTP (health check) |
| `WG_AGENT_RATE_LIMIT` | `10` | Ð›Ð¸Ð¼Ð¸Ñ‚ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð² ÑÐµÐºÑƒÐ½Ð´Ñƒ |
| `WG_SERVER_PORT` | `51820` | ÐŸÐ¾Ñ€Ñ‚ WireGuard |
| `WG_SERVER_IP` | `10.8.0.1/24` | IP Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½ VPN |

---

## Troubleshooting

### Ð¡ÐµÑ€Ð²Ð¸Ñ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ
```bash
journalctl -u wg-agent -n 50
```

### WireGuard Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
```bash
wg show wg0
systemctl status wg-quick@wg0
```

### Ð‘Ð¾Ñ‚ Ð½Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ÑÑ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ
1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ñ€Ñ‚ 7443 Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ Ð² firewall
2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ Ñ‡Ñ‚Ð¾ TLS ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ Ð² Ð±Ð¾Ñ‚Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ
3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ health: `curl http://SERVER_IP:8080/health`

---

## Ð ÐµÐ·ÑŽÐ¼Ðµ: Ñ‡Ñ‚Ð¾ Ð³Ð´Ðµ Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑÑ

| Ð§Ñ‚Ð¾ | Ð“Ð´Ðµ | Ð”Ð»Ñ Ñ‡ÐµÐ³Ð¾ |
|-----|-----|----------|
| `certs/ca.pem`, `certs/ca-key.pem` | Ð¢Ð²Ð¾Ð¹ ÐºÐ¾Ð¼Ð¿ | Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑÐµÑ€Ð²ÐµÑ€Ð½Ñ‹Ñ… ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð² |
| `certs/client.pem`, `certs/client-key.pem` | Ð¢Ð²Ð¾Ð¹ ÐºÐ¾Ð¼Ð¿ â†’ Ð±Ð¾Ñ‚ | ÐÐ²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð¾Ñ‚Ð° Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ð°Ñ… |
| `CA_CERT_PEM`, `CA_KEY_PEM` | .env Ð½Ð° ÐºÐ°Ð¶Ð´Ð¾Ð¼ VPS | Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑÐµÑ€Ð²ÐµÑ€Ð½Ð¾Ð³Ð¾ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð° |
| `WIREGUARD_TLS_*` | .env Ð±Ð¾Ñ‚Ð° | ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº wg-agent ÑÐµÑ€Ð²ÐµÑ€Ð°Ð¼ |
